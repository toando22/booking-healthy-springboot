<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <th:block th:replace="~{admin/include/header :: header (title='Dashboard')}"></th:block>
</head>

<body>

<th:block th:replace="~{admin/include/header :: header-nav}"></th:block>
<th:block th:replace="~{admin/include/sidebar :: sidebar}"></th:block>

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Dashboard</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Home</a></li>
        <li class="breadcrumb-item active">Dashboard</li>
      </ol>
    </nav>
  </div>

  <section class="section dashboard">
    <div class="row">

      <div class="col-xxl-4 col-md-6">
        <div class="card info-card revenue-card">
          <div class="card-body">
            <h5 class="card-title">Tổng số Bệnh nhân</h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                <i class="bi bi-people"></i>
              </div>
              <div class="ps-3">
                <h6 th:text="${patientCount}">0</h6>
                <span class="text-muted small pt-2 ps-1">Bệnh nhân (User)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-4 col-md-6">
        <div class="card info-card customers-card">
          <div class="card-body">
            <h5 class="card-title">Tổng số Bác sĩ</h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                <i class="bi bi-person-badge"></i>
              </div>
              <div class="ps-3">
                <h6 th:text="${doctorCount}">0</h6>
                <span class="text-muted small pt-2 ps-1">Bác sĩ (Doctor)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xxl-4 col-xl-12">
        <div class="card info-card sales-card">
          <div class="card-body">
            <h5 class="card-title">Tổng số Lịch hẹn</h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                <i class="bi bi-calendar-check"></i>
              </div>
              <div class="ps-3">
                <h6 th:text="${bookingCount}">0</h6>
                <span class="text-muted small pt-2 ps-1">Lịch hẹn (Booking)</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Báo cáo <span>| 7 ngày qua</span></h5>
            <div id="reportsChart"></div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card recent-sales overflow-auto">
          <div class="card-body">
            <h5 class="card-title">Lịch hẹn Gần đây <span>| Tất cả</span></h5>
            <table class="table table-borderless datatable">
              <thead>
              <tr>
                <th scope="col">#ID</th>
                <th scope="col">Bệnh nhân</th>
                <th scope="col">Bác sĩ</th>
                <th scope="col">Giá (VNĐ)</th>
                <th scope="col">Trạng thái</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="booking : ${listBookings}">
                <th scope="row">
                  <a th:href="@{/admin/manage-booking}" th:text="'#' + ${booking.id}">#ID</a>
                </th>
                <td th:text="${booking.user.fullName}">Tên BN</td>
                <td th:text="${booking.doctor.user.fullName}">Tên BS</td>
                <td th:text="${#numbers.formatDecimal(booking.bookingPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">300.000</td>
                <td>
                  <span th:if="${booking.status.name() == 'PENDING'}" class="badge bg-warning">Chờ xác nhận</span>
                  <span th:if="${booking.status.name() == 'CONFIRMED'}" class="badge bg-success">Đã xác nhận</span>
                  <span th:if="${booking.status.name() == 'CANCELED'}" class="badge bg-danger">Đã hủy</span>
                  <span th:if="${booking.status.name() == 'COMPLETED'}" class="badge bg-secondary">Đã hoàn thành</span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<th:block th:replace="~{admin/include/footer :: footer}"></th:block>

<script th:src="@{/assets-admin/vendor/apexcharts/apexcharts.min.js}"></script>
<script th:src="@{/assets-admin/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets-admin/vendor/echarts/echarts.min.js}"></script>
<script th:src="@{/assets-admin/vendor/simple-datatables/simple-datatables.js}"></script>
<script th:src="@{/assets-admin/js/main.js}"></script>

<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const baseUrl = /*[[@{/}]]*/ '';

    fetch(baseUrl + 'api/dashboard/booking-stats-7days')
      .then(response => response.json())
      .then(data => {
        const categories = data.map(item => item.date);
        const seriesData = data.map(item => item.count);

        new ApexCharts(document.querySelector("#reportsChart"), {
          series: [{
            name: 'Lịch hẹn mới',
            data: seriesData,
          }],
          chart: {
            height: 350,
            type: 'area',
            toolbar: {
              show: false
            },
          },
          markers: {
            size: 4
          },
          colors: ['#4154f1'],
          fill: {
            type: "gradient",
            gradient: {
              shadeIntensity: 1,
              opacityFrom: 0.3,
              opacityTo: 0.4,
              stops: [0, 90, 100]
            }
          },
          dataLabels: {
            enabled: false
          },
          stroke: {
            curve: 'smooth',
            width: 2
          },
          xaxis: {
            type: 'datetime',
            categories: categories
          },
          tooltip: {
            x: {
              format: 'dd/MM/yy'
            },
          }
        }).render();
      })
      .catch(error => console.error('Lỗi khi tải dữ liệu biểu đồ:', error));
  });
</script>
</body>
</html>